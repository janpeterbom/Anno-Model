var anno_modal=function(){"use strict";function e(){var e=navigator.userAgent.toLowerCase();return-1!==e.indexOf("msie")?parseInt(e.split("msie")[1],10):!1}function n(e,n,o){var t=new XMLHttpRequest;t.open("POST",e,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){4===t.readyState&&(200===t.status||304===t.status)&&n(t.responseText)},t.send(o)}var o="Pencil",t=[],a=["#331900","#333300","#193300","#003300","#003319","#003333","#001933","#000033","#190033","#330033","#330019","#000000","#663300","#666600","#336600","#006600","#006633","#006666","#003366","#000066","#330066","#660066","#660033","#202020","#994C00","#999900","#4C9900","#009900","#00994C","#009999","#004C99","#000099","#4C0099","#990099","#99004C","#404040","#CC6600","#CCCC00","#66CC00","#00CC00","#00CC66","#00CCCC","#0066CC","#0000CC","#6600CC","#CC00CC","#CC0066","#606060","#FF8000","#FFFF00","#80FF00","#00FF00","#00FF80","#00FFFF","#0080FF","#0000FF","#7F00FF","#FF00FF","#FF007F","#808080","#FF9933","#FFFF33","#99FF33","#33FF33","#33FF99","#33FFFF","#3399FF","#3333FF","#9933FF","#FF33FF","#FF3399","#A0A0A0","#FFB266","#FFFF66","#B2FF66","#66FF66","#66FFB2","#66FFFF","#66B2FF","#6666FF","#B266FF","#FF66FF","#FF66B2","#C0C0C0","#FFCC99","#FFFF99","#CCFF99","#99FF99","#99FFCC","#99FFFF","#99CCFF","#9999FF","#CC99FF","#FF99FF","#FF99CC","#E0E0E0","#FFE5CC","#FFFFCC","#E5FFCC","#CCFFCC","#CCFFE5","#CCFFFF","#CCE5FF","#CCCCFF","#E5CCFF","#FFCCFF","#FFCCE5","#FFFFFF"],l=0,i=-1,d="#fff",s="",r="",c=900,m="",v=900,u=0,p=!1,F=!1,h=400,g=!1,f=[],y=!1,C,k=!1,x=!0,w=!0,L=!0,b,E="",_=function(e){return document.querySelector(e)},T=function(e){return document.querySelectorAll(e)};return{historySave:function(){for(i++;t.length>20;)t.shift(),i--;0!==i&&i<t.length?(t.length=i,i++):t.length=i,t.push(C.toDataURL()),anno_modal.Resetselected(o),anno_modal.undoredorefresh(),F=!0},undoredorefresh:function(){_("#annomodalundo").style.display="none",_("#annomodalredo").style.display="none",_("#annomodalundo_n").style.display="",_("#annomodalredo_n").style.display="",i>0&&(_("#annomodalundo").style.display="",_("#annomodalundo_n").style.display="none"),i<t.length-1&&(_("#annomodalredo").style.display="",_("#annomodalredo_n").style.display="none")},Undo:function(){if(i>-1){i--;var e=new Image;e.src=t[i],e.onload=function(){s.clearRect(0,0,c,u),s.drawImage(e,0,0)},anno_modal.undoredorefresh()}},Redo:function(){if(i<t.length-1){i++;var e=new Image;e.src=t[i],e.onload=function(){s.clearRect(0,0,c,u),s.drawImage(e,0,0)},anno_modal.undoredorefresh()}},Clear:function(){if(i>-1){i=0;var e=new Image;e.src=t[i],e.onload=function(){s.clearRect(0,0,c,u),s.drawImage(e,0,0)},anno_modal.undoredorefresh()}},Resetselected:function(e){o=e;for(var n=T(".anno-seletedtools"),t=0,a=n.length;a>t;t++)n[t].style.border="2px solid #fff";switch(e){case"Pencil":_("#annomodalpen").style.border="2px solid #199A3F";break;case"Rectangle":_("#annomodalrect").style.border="2px solid #199A3F";break;case"Circle":_("#annomodalcirc").style.border="2px solid #199A3F";break;case"Line":_("#annomodalline").style.border="2px solid #199A3F";break;case"Text":_("#annomodaltext").style.border="2px solid #199A3F"}},getFullurl:function(e){var n=document.createElement("div"),o=e.split("&").join("&amp;").split("<").join("&lt;").split('"').join("&quot;");return n.innerHTML='<a href="'+o+'">x</a>',encodeURIComponent(n.firstChild.href)},drawStrokedText:function(e,n,o,t,a,l){g=!1;var i=window.prompt("Please enter your text","");null!==i&&(s.font=a+" "+t,s.beginPath(),o>0&&l===!0&&("#000000"===d?s.fillStyle="#ffffff":s.fillStyle="#000000",s.fillText(i,e-o,n-o),s.fillText(i,e+o,n-o),s.fillText(i,e-o,n),s.fillText(i,e+o,n),s.fillText(i,e-o,n+o),s.fillText(i,e+o,n+o)),s.fillStyle=d,s.fillText(i,e,n),s.closePath(),s.stroke(),anno_modal.historySave())},loadannopresrc:function(e,o,t,a){var l=new Date,i="",d="",s="";try{d=e.attributes.signatureid.value}catch(r){}try{s=e.attributes.annoid.value,"give"===s&&(e.attributes.annoid.value=l.getTime(),s=l.getTime())}catch(r){}try{i=e.attributes.filename.value}catch(r){}var c=i.substring(i.lastIndexOf("/")+1);n(o,function(n){if("true"===n){var o=new Image,a=document.createElement("canvas"),i=a.getContext("2d");o.onload=function(){a.width=e.width,a.height=e.height,i.drawImage(e,0,0,e.width,e.height),i.drawImage(o,0,0,e.width,e.height);var n=a.toDataURL("image/png");e.setAttribute("src",n)},o.onerror=function(){o=null,_("#anno_note").style.display="none"},o.src=t+c.replace(/\.[^/.]+$/,"")+s+d+"_anno.png?"+l.getTime()}},"filename="+c.replace(/\.[^/.]+$/,"")+s+d+"_anno.png&check=true&destdir="+a)},init:function(){function g(e){function g(e){27===e.keyCode&&_("#annomodalok").click()}function T(e,n){if(e.classList)e.classList.toggle(n);else{var o=e.className.split(" "),t=o.indexOf(n);t>=0?o.splice(t,1):(o.push(n),e.className=o.join(" "))}}function S(e,n){var o=!1;return o=e.classList?e.classList.contains(n):new RegExp("(^| )"+n+"( |$)","gi").test(e.className)}function I(e){D.length>0&&39===e.keyCode&&(document.removeEventListener("keyup",I),F===!0?(E="next",_("#annomodalsave").click()):(_("#anno_this").style.display="none",O=null,_("#annomodalnext").click())),z.length>0&&37===e.keyCode&&(document.removeEventListener("keyup",I),F===!0?(E="prev",_("#annomodalsave").click()):(_("#anno_this").style.display="none",O=null,_("#annomodalprev").click())),27===e.keyCode&&_("#annomodalok").click()}var P="",D=[],z=[],M="",W="",O=new Image,q=0,U=e,B=!0,N="",H="",j=!1;_("#annoloader").style.display="block";try{N=U.currentTarget.attributes.signatureid.value,N.length>0&&(j=!0)}catch(Y){}try{H=U.currentTarget.attributes.annoid.value}catch(Y){}try{P=U.currentTarget.attributes.filename.value}catch(Y){}u=h,c=R.Maxsize,v=R.Maxsize,h>c&&(c=h,R.Maxsize=h),h>v&&(v=h),t.length=0,i=-1;for(var J=0,X=m.length;X>J;J++)m[J]===this&&X-1>J&&D.push(m[J+1]),m[J]===this&&J>0&&z.push(m[J-1]),m[J]===this&&(q=J);""===P&&(P=U.currentTarget.src,B=!1),M=D.length>0?'<div class="anno-seletedtools" id="annomodalnext" tooltip="Next image"></div>':'<div class="anno-seletedtools anno-none-np" ></div>',W=z.length>0?'<div class="anno-seletedtools" id="annomodalprev" tooltip="Previous image"></div>':'<div class="anno-seletedtools anno-none-np"></div>',document.removeEventListener("keyup",I),document.removeEventListener("keyup",g),O.onload=function(){c=this.width*(v/this.height)>R.Maxsize?R.Maxsize:this.width*(v/this.height),v=c*this.height/this.width,v=Number(v.toFixed()),c=Number(c.toFixed()),u=j?200>v?200:v:h>v?h:v;var m=_("#anno_this");m.innerHTML="",m.style.width=c+100+"px",m.style.height=u+"px",m.innerHTML='<div id="annomodalbackdiv"><img id="annomodalimg" class="anno_this-img" src="'+P+'" alt="" width="'+c+'" /><canvas id="annomodalcanvas" width="'+c+'" height="'+u+'"></canvas><canvas id="anno_tmpcanvas" width="'+c+'" height="'+u+'"></canvas></div><div id="anno_note">Loading ... Please wait!</div><div id="annomodaltools"><div tooltip="Magnify the image to original size" class="anno-seletedtools anno-none" id="annononepart"></div>'+A+'<div class="anno-seletedtools" id="annomodalok" tooltip="Close"></div><br><div class="anno-seletedtools annomodalpen" id="annomodalpen" tooltip="Pen tool"></div><div class="anno-seletedtools annomodalrect" id="annomodalrect" tooltip="Click for Stroked Rectangle Tool"></div><div class="anno-seletedtools annomodalcirc" id="annomodalcirc" tooltip="Click for Stroked Circle Tool"></div><div class="anno-seletedtools" id="annomodalline" tooltip="Line tool"></div><div class="anno-seletedtools" id="annomodaltext" tooltip="Text tool"></div><div class="anno-seletedtools" id="annocolorselector" tooltip="Color selector and line width  selection"></div><div class="anno-seletedtools" id="annomodalclear" tooltip="Clear the Annotation"></div><div class="anno-seletedtools" id="annomodalsave" tooltip="Save the annotated canvas"></div><div class="anno-seletedtools" id="annomodalundo" tooltip="Undo"></div><div class="anno-seletedtools anno-none" id="annomodalundo_n"></div><div class="anno-seletedtools" id="annomodalredo" tooltip="Redo"></div><div class="anno-seletedtools anno-none" id="annomodalredo_n"></div><br><div class="anno-seletedtools" id="annomodaldownload" tooltip="Download original image"></div><div class="anno-seletedtools" id="annomodaldowncanvas" tooltip="Download annotated image"></div><div class="anno-mb">'+W+M+"</div></div>",_("#anno_note").style.display="none",_("#annoloader").style.display="none",_("#annomodalimg").onload=function(){var h=_("#annomodalbackdiv");h.style.width=c+"px",h.style.height=u+"px",h=null,l=a.length,_("#annocolorselector").style.backgroundColor=d;var A=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;m.style.top=A+u/2+40+"px",_("#annozoom").style.top=A+40+"px",m.style.left="50%",m.style.margin="-"+u/2+"px 0 0 -"+(c+100)/2+"px",m.style.display="block";var M=function(){_("#annocolorselector").style.display="none",_("#annomodalrect").style.display="none",_("#annomodalcirc").style.display="none",_("#annomodalline").style.display="none",_("#annomodalpen").style.display="none",_("#annocolorselector").style.display="none",_("#annomodalredo_n").style.display="none",_("#annomodaldowncanvas").style.display="none",_("#annomodaldownload").style.display="none",_("#annononepart").style.display="none",_("#annomodaltext").style.display="none",_("#annomodalundo_n").style.display="none",_("#annomodalredo").style.display="none",_("#annomodalundo").style.display="none",R.lineWidth=4,d="#000000",anno_modal.Resetselected("Pencil")};j&&M();var W=function(){_("#annozoom img").setAttribute("src",O.src),_("#annozoom").style.display="block"},U=function(){return _("#anno_clor").style.display="block",!1},Y=function(){_("#annozoom").style.display="none"},J=function(e){""===e.target.id?(d=e.target.style.backgroundColor,_("#annocolorselector").style.backgroundColor=d):(R.lineWidth=e.target.id.replace(/^\D+/g,""),R.lineWidth=2*R.lineWidth),_("#anno_clor").style.display="none"},X=function(){var e="Pencil"!==o?!0:!1;e||T(_("#annomodalpen"),"annopenfill"),S(_("#annomodalpen"),"annopenfill")?(_("#annomodalpen").setAttribute("tooltip","40% opaque Marker Pen Tool"),L=!0):(_("#annomodalpen").setAttribute("tooltip","Pen Tool"),L=!1),anno_modal.Resetselected("Pencil")},G=function(){var e="Rectangle"!==o?!0:!1;e||T(_("#annomodalrect"),"annorectfill"),S(_("#annomodalrect"),"annorectfill")?(_("#annomodalrect").setAttribute("tooltip","30% opaque Rectangle Tool"),x=!0):(_("#annomodalrect").setAttribute("tooltip","Stroked Rectangle Tool"),x=!1),anno_modal.Resetselected("Rectangle")},K=function(){var e="Circle"!==o?!0:!1;e||T(_("#annomodalcirc"),"annocircfill"),S(_("#annomodalcirc"),"annocircfill")?(_("#annomodalcirc").setAttribute("tooltip","30% opaque Circle Tool"),w=!0):(_("#annomodalcirc").setAttribute("tooltip","Stroked Circle Tool"),w=!1),anno_modal.Resetselected("Circle")},Q=function(){anno_modal.Resetselected("Line")},V=function(){anno_modal.Resetselected("Text")},Z=function(){anno_modal.Undo()},ee=function(){anno_modal.Redo()},ne=function(){F=!0,anno_modal.Clear()},oe=function(){F===!0?(E="prev",_("#annomodalsave").click()):(m.style.display="none",O=null,re(),z[0].click())},te=function(){F===!0?(E="next",_("#annomodalsave").click()):(m.style.display="none",O=null,re(),D[0].click())},ae=function(){D.length>0&&_("#annomodalnext").addEventListener("click",te),z.length>0&&_("#annomodalprev").addEventListener("click",oe),D.length>0||z.length>0?document.addEventListener("keyup",I):document.addEventListener("keyup",g)},le=function(){var e=document.createElement("canvas");e.width=C.width,e.height=C.height;var o=e.getContext("2d");o.fillStyle="#FFFFFF",o.fillRect(0,0,c,u),o.drawImage(O,0,0,c,v),o.drawImage(C,0,0);var t=e.toDataURL("image/png");n(R.uploadScript,function(e){window.open(R.uploadScript+"?path="+anno_modal.getFullurl(R.annoImgDir+e)+"&download=true","_self")},"img="+t+"&filename="+P+"&destdir="+R.uploadDir)},ie=function(){e.preventDefault(),window.open(R.uploadScript+"?path="+anno_modal.getFullurl(P)+"&download=true","_self")},de=function(){var e=C.toDataURL("image/png");if(n(R.uploadScript,function(){switch(_("#annomodalsave").style.border="2px solid #1AAF06",document.removeEventListener("keyup",g),E){case"close":O=null,t.length=0,i=-1,p=!1,re(),_("#anno_this").style.display="none";break;case"next":t.length=0,i=-1,_("#anno_this").style.display="none",O=null,D[0].click(),re();break;case"prev":t.length=0,i=-1,_("#anno_this").style.display="none",O=null,z[0].click(),re()}E=""},"img="+e+"&filename="+P+"&destdir="+R.uploadDir+"&si="+N+"&ai="+H),B===!0){var o=document.createElement("canvas");o.width=C.width,o.height=C.height;var a=o.getContext("2d");a.fillStyle="#FFFFFF",a.fillRect(0,0,c,u),a.drawImage(O,0,0,c,v),a.drawImage(C,0,0);var l=o.toDataURL("image/png");R.onSave({index:q,imagedata:l,annofilename:P.substring(P.lastIndexOf("/")+1).replace(/\.[^/.]+$/,"")+H+N+"_anno.png"})}},se=function(){document.removeEventListener("keyup",I),document.removeEventListener("keyup",g),F===!0?(E="close",_("#annomodalsave").click()):(O=null,t.length=0,i=-1,p=!1,re(),_("#anno_this").style.display="none")},re=function(){_("#annononepart").removeEventListener("click",W),_("#annocolorselector").removeEventListener("click",U),_("#annozoom").removeEventListener("click",Y),_("#annomodalpen").removeEventListener("click",X),_("#annomodalrect").removeEventListener("click",G),_("#annomodalcirc").removeEventListener("click",K),_("#annomodalline").removeEventListener("click",Q),_("#annomodaltext").removeEventListener("click",V),_("#annomodalundo").removeEventListener("click",Z),_("#annomodalredo").removeEventListener("click",ee),_("#annomodalclear").removeEventListener("click",ne),D.length>0&&_("#annomodalnext").removeEventListener("click",te),z.length>0&&_("#annomodalprev").removeEventListener("click",oe),document.removeEventListener("keyup",I),_("#annomodaldowncanvas").removeEventListener("click",le),_("#annomodaldownload").removeEventListener("click",ie),_("#annomodalsave").removeEventListener("click",de),_("#annomodalok").removeEventListener("click",se)};re(),_("#annononepart").addEventListener("click",W),_("#annocolorselector").addEventListener("click",U),_("#annozoom").addEventListener("click",Y),_("#annomodalpen").addEventListener("click",X),_("#annomodalrect").addEventListener("click",G),_("#annomodalcirc").addEventListener("click",K),_("#annomodalline").addEventListener("click",Q),_("#annomodaltext").addEventListener("click",V),_("#annomodalundo").addEventListener("click",Z),_("#annomodalredo").addEventListener("click",ee),_("#annomodalclear").addEventListener("click",ne),_("#anno_clor_select").addEventListener("click",J),_("#annomodaldowncanvas").addEventListener("click",le),_("#annomodaldownload").addEventListener("click",ie),_("#annomodalsave").addEventListener("click",de),_("#annomodalok").addEventListener("click",se),t.length=0,anno_modal.Resetselected(o),x=!1,w=!1,L=!1,C=document.getElementById("annomodalcanvas"),b=document.getElementById("anno_tmpcanvas");var ce=function(e){return e.preventDefault(),r.lineJoin=r.lineCap="round",f.length=0,r.lineWidth=R.lineWidth,r.strokeStyle=d,r.globalAlpha=1,f.push({x:e.pageX-C.offsetParent.offsetLeft-15,y:e.pageY-C.offsetParent.offsetTop-15}),"Text"===o?(anno_modal.drawStrokedText(f[0].x,f[0].y,1,R.textFont,R.textFontSize,R.textOutline),!1):void(y=!0)},me=function(e){if(e.preventDefault(),y===!0){r.clearRect(0,0,r.canvas.width,r.canvas.height),f.push({x:e.pageX-C.offsetParent.offsetLeft-15,y:e.pageY-C.offsetParent.offsetTop-15});var n=f.length-1,t=f[n].x-f[0].x,a=f[n].y-f[0].y,l=Math.sqrt(t*t+a*a);if("Pencil"===o){r.beginPath(),r.moveTo(f[0].x,f[0].y),L===!0?(r.globalAlpha=.4,r.lineWidth=R.lineWidth,r.lineJoin=r.lineCap="round"):(r.lineJoin=r.lineCap="round",r.globalAlpha=1,r.lineWidth=R.lineWidth);for(var i=1;i<f.length-1;i++){var s=(f[i].x+f[i+1].x)/2,c=(f[i].y+f[i+1].y)/2;r.quadraticCurveTo(f[i].x,f[i].y,s,c)}r.stroke()}else"Rectangle"===o?(r.beginPath(),r.rect(f[0].x,f[0].y,t,a),x===!0?(r.globalAlpha=.2,r.strokeStyle="rgba(0, 0, 0, 0)",r.fillStyle=d):(r.globalAlpha=1,r.fillStyle="rgba(0, 0, 0, 0)",r.strokeStyle=d),r.fillRect(f[0].x,f[0].y,t,a),r.closePath(),r.fill(),r.stroke()):"Line"===o?(r.beginPath(),r.moveTo(f[0].x,f[0].y),r.lineTo(f[n].x,f[n].y),r.closePath(),r.stroke()):"Circle"===o&&(r.beginPath(),r.arc(f[0].x,f[0].y,l,0,2*Math.PI,!0),w===!0?(r.globalAlpha=.4,r.strokeStyle="rgba(0, 0, 0, 0)",r.fillStyle=d):(r.globalAlpha=1,r.fillStyle="rgba(0, 0, 0, 0)",r.strokeStyle=d),r.closePath(),r.fill(),r.stroke())}},ve=function(){y!==!1&&(y=!1,f.length=0,s.drawImage(b,0,0),r.clearRect(0,0,r.canvas.width,r.canvas.height),anno_modal.historySave())};if(C){s=C.getContext("2d"),r=b.getContext("2d");var ue=new Date;anno_modal.historySave(),F=!1;var pe=P.substring(P.lastIndexOf("/")+1),Fe=function(e){s.drawImage(e,0,0,c,u),p=!0,F=!1,_("#anno_note").style.display="none",ae(),anno_modal.historySave(),F=!1};n(R.uploadScript,function(e){if("true"===e){_("#anno_note").style.display="block";var n=new Image;n.onload=function(){k?setTimeout(function(){Fe(n),n=null},400):(Fe(n),n=null)},n.onerror=function(){n=null,_("#anno_note").style.display="none",ae()},n.src=R.annoImgDir+pe.replace(/\.[^/.]+$/,"")+H+N+"_anno.png?"+ue.getTime()}else ae()},"check=true&filename="+pe.replace(/\.[^/.]+$/,"")+H+N+"_anno.png&destdir="+R.uploadDir),y=!1,b.addEventListener("mousedown",ce,!1),b.addEventListener("touchstart",ce,!1),b.addEventListener("mousemove",me,!1),b.addEventListener("touchmove",me,!1),b.addEventListener("mouseup",ve,!1),b.addEventListener("touchend",ve,!1),R.closeondblclick&&b.addEventListener("dblclick",se,!1)}}},O.src=P}var S="<div id='annoloader'></div><div id='annozoom'><img title='click to close' src=''></div><div class='anno-modal' id='anno_this'/></div>",R=arguments[0]||"";R.lineWidth=R.lineWidth||5,R.Maxsize=R.Maxsize||900,R.drawColor=R.drawColor||"#FF0106",R.uploadScript=R.uploadScript||"php/anno_modal.php",R.uploadDir=R.uploadDir||"../uploaded/images/",R.textFont=R.textFont||"Arial",R.textOutline=R.textOutline||!1,R.textFontSize=R.textFontSize||"35px",R.annoImgDir=R.annoImgDir||"uploaded/images/",R.closeondblclick=R.closeondblclick||!1,R.selectedTool=R.selectedTool||"Pencil",R.preloadAnotation=R.preloadAnotation||!1,R.onSave=R.onSave||function(){},d=R.drawColor;for(var A="<div id='anno_clor'><ul id='anno_clor_select'>",I=a.length-1;I>=0;I--)A+="<li style=' background-color:"+a[I]+"'></li>";for(I=1;12>=I;I++)A+="<li id='annonlinew"+I+"'></li>";if(A+="</ul></div>",o=R.selectedTool,document.body.innerHTML+=S,m=T(".anno-this"),e()&&(k=!0),R.preloadAnotation===!0)for(var P=0,D=m.length;D>P;P++)try{anno_modal.loadannopresrc(m[P],R.uploadScript,R.annoImgDir,R.uploadDir)}catch(z){}for(var M=T(".anno-this"),W=0,O=M.length;O>W;W++)M[W].addEventListener("click",g);M=null}}}();